openapi: 3.0.3
info:
  title: Traceability and Audit API
  description: API para auditoría y trazabilidad de cambios de estado de pedidos
  version: 1.0.0
  contact:
    name: Pragma PowerUp Team

servers:
  - url: http://localhost:8083
    description: Servidor local de desarrollo


paths:
  /audit/order-status:
    post:
      tags:
        - Audit
      summary: Registrar auditoría de cambio de estado
      description: Registra un cambio de estado de un pedido para auditoría
      operationId: createOrderStatusAudit
      requestBody:
        description: Datos de la auditoría a registrar
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderStatusAuditRequest'
      responses:
        '201':
          description: Auditoría registrada exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderStatusAuditDataResponse'
        '400':
          description: Datos de entrada inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    get:
      tags:
        - Audit
      summary: Consultar historial de auditoría
      description: Obtiene el historial de cambios de estado con filtros opcionales. Los clientes solo pueden ver sus propios pedidos.
      operationId: getOrderStatusAuditHistory
      parameters:
        - name: clientId
          in: query
          description: ID del cliente (obligatorio para clientes, opcional para otros roles)
          required: false
          schema:
            type: integer
            format: int64
        - name: orderId
          in: query
          description: ID del pedido
          required: false
          schema:
            type: integer
            format: int64
        - name: actionTypes
          in: query
          description: Tipos de acción a filtrar (múltiples valores permitidos)
          required: false
          schema:
            type: array
            items:
              type: string
          style: form
          explode: true
        - name: page
          in: query
          description: Número de página
          required: false
          schema:
            type: integer
            default: 0
        - name: size
          in: query
          description: Tamaño de página
          required: false
          schema:
            type: integer
            default: 10
      responses:
        '200':
          description: Historial obtenido exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderStatusAuditListResponse'
        '400':
          description: Parámetros de consulta inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /audit/metrics/orders-duration:
    get:
      tags:
        - Metrics
      summary: Obtener duración de pedidos
      description: |
        Obtiene el tiempo de duración de cada pedido desde que inicia (estado Pendiente) 
        hasta que termina (estado Entregado o Cancelado). Permite identificar pedidos 
        que tardan más que el promedio para optimizarlos.
      operationId: getOrdersDurationMetrics
      parameters:
        - name: restaurantId
          in: query
          description: ID del restaurante para filtrar pedidos
          required: true
          schema:
            type: integer
            format: int64
        - name: startDate
          in: query
          description: Fecha de inicio del rango de consulta (formato ISO 8601)
          required: false
          schema:
            type: string
            format: date-time
            example: "2025-12-01T00:00:00"
        - name: endDate
          in: query
          description: Fecha de fin del rango de consulta (formato ISO 8601)
          required: false
          schema:
            type: string
            format: date-time
            example: "2025-12-31T23:59:59"
        - name: page
          in: query
          description: Número de página
          required: false
          schema:
            type: integer
            default: 0
        - name: size
          in: query
          description: Tamaño de página
          required: false
          schema:
            type: integer
            default: 20
        - name: sortBy
          in: query
          description: Campo por el cual ordenar (durationMinutes, orderId, completedAt)
          required: false
          schema:
            type: string
            default: "durationMinutes"
            enum:
              - durationMinutes
              - orderId
              - completedAt
        - name: sortDirection
          in: query
          description: Dirección del ordenamiento
          required: false
          schema:
            type: string
            default: "DESC"
            enum:
              - ASC
              - DESC
      responses:
        '200':
          description: Métricas obtenidas exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrdersDurationMetricsResponse'
        '400':
          description: Parámetros de consulta inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /audit/metrics/employee-efficiency:
    get:
      tags:
        - Metrics
      summary: Obtener ranking de eficiencia de empleados
      description: |
        Obtiene un ranking de empleados mostrando el tiempo medio entre que un pedido 
        inicia (Pendiente) y termina (Entregado o Cancelado). Permite identificar 
        empleados con mejor rendimiento.
      operationId: getEmployeeEfficiencyMetrics
      parameters:
        - name: restaurantId
          in: query
          description: ID del restaurante para filtrar empleados
          required: true
          schema:
            type: integer
            format: int64
        - name: startDate
          in: query
          description: Fecha de inicio del rango de consulta (formato ISO 8601)
          required: false
          schema:
            type: string
            format: date-time
            example: "2025-12-01T00:00:00"
        - name: endDate
          in: query
          description: Fecha de fin del rango de consulta (formato ISO 8601)
          required: false
          schema:
            type: string
            format: date-time
            example: "2025-12-31T23:59:59"
        - name: minOrdersCompleted
          in: query
          description: Número mínimo de pedidos completados para aparecer en el ranking
          required: false
          schema:
            type: integer
            default: 1
        - name: page
          in: query
          description: Número de página
          required: false
          schema:
            type: integer
            default: 0
        - name: size
          in: query
          description: Tamaño de página
          required: false
          schema:
            type: integer
            default: 20
        - name: sortBy
          in: query
          description: Campo por el cual ordenar (averageDurationMinutes, totalOrdersCompleted, employeeId)
          required: false
          schema:
            type: string
            default: "averageDurationMinutes"
            enum:
              - averageDurationMinutes
              - totalOrdersCompleted
              - employeeId
        - name: sortDirection
          in: query
          description: Dirección del ordenamiento
          required: false
          schema:
            type: string
            default: "ASC"
            enum:
              - ASC
              - DESC
      responses:
        '200':
          description: Ranking de eficiencia obtenido exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EmployeeEfficiencyMetricsResponse'
        '400':
          description: Parámetros de consulta inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'


components:
  schemas:
    # Response específico para crear/obtener auditoría
    OrderStatusAuditDataResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/OrderStatusAuditResponse'
      required:
        - data

    # Response para lista de auditorías
    OrderStatusAuditListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/OrderStatusAuditResponse'
        meta:
          $ref: '#/components/schemas/PaginationMeta'
      required:
        - data
        - meta

    PaginationMeta:
      type: object
      properties:
        page:
          type: integer
          description: Página actual
          example: 0
        size:
          type: integer
          description: Elementos por página
          example: 10
        totalElements:
          type: integer
          description: Total de elementos
          example: 100
        totalPages:
          type: integer
          description: Total de páginas
          example: 10

    OrderStatusAuditRequest:
      type: object
      properties:
        orderId:
          type: integer
          format: int64
          description: ID del pedido
          example: 1
        restaurantId:
          type: integer
          format: int64
          description: ID del restaurante
          example: 5
        clientId:
          type: integer
          format: int64
          description: ID del cliente
          example: 10
        previousStatus:
          type: string
          maxLength: 50
          description: Estado anterior del pedido
          example: "PENDIENTE"
        newStatus:
          type: string
          maxLength: 50
          description: Nuevo estado del pedido
          example: "EN_PREPARACION"
        changedByUserId:
          type: integer
          format: int64
          description: ID del usuario que realizó el cambio
          example: 7
        changedByRole:
          type: string
          maxLength: 50
          description: Rol del usuario que realizó el cambio
          example: "EMPLEADO"
        actionType:
          type: string
          maxLength: 50
          description: Tipo de acción realizada
          example: "STATUS_CHANGE"
        employeeId:
          type: integer
          format: int64
          description: ID del empleado asignado (si aplica)
          example: 7
        ipAddress:
          type: string
          maxLength: 45
          description: Dirección IP desde donde se realizó el cambio
          example: "192.168.1.100"
        userAgent:
          type: string
          maxLength: 500
          description: User agent del navegador/cliente
          example: "Mozilla/5.0"
        notes:
          type: string
          maxLength: 1000
          description: Notas adicionales
          example: "Pedido asignado al empleado"
        timeInPreviousStatusMinutes:
          type: integer
          format: int64
          description: Tiempo en el estado anterior en minutos
          example: 15
      required:
        - orderId
        - restaurantId
        - clientId
        - newStatus
        - changedByUserId
        - changedByRole

    OrderStatusAuditResponse:
      type: object
      properties:
        id:
          type: string
          description: ID único de la auditoría (MongoDB ObjectId)
          example: "507f1f77bcf86cd799439011"
        orderId:
          type: integer
          format: int64
          description: ID del pedido
          example: 1
        restaurantId:
          type: integer
          format: int64
          description: ID del restaurante
          example: 5
        clientId:
          type: integer
          format: int64
          description: ID del cliente
          example: 10
        previousStatus:
          type: string
          description: Estado anterior del pedido
          example: "PENDIENTE"
        newStatus:
          type: string
          description: Nuevo estado del pedido
          example: "EN_PREPARACION"
        changedByUserId:
          type: integer
          format: int64
          description: ID del usuario que realizó el cambio
          example: 7
        changedByRole:
          type: string
          description: Rol del usuario que realizó el cambio
          example: "EMPLEADO"
        changedAt:
          type: string
          format: local-date-time
          description: Fecha y hora del cambio
          example: "2025-12-02T10:30:00Z"
        actionType:
          type: string
          description: Tipo de acción realizada
          example: "STATUS_CHANGE"
        employeeId:
          type: integer
          format: int64
          description: ID del empleado asignado (si aplica)
          example: 7
        ipAddress:
          type: string
          description: Dirección IP desde donde se realizó el cambio
          example: "192.168.1.100"
        userAgent:
          type: string
          description: User agent del navegador/cliente
          example: "Mozilla/5.0"
        notes:
          type: string
          description: Notas adicionales
          example: "Pedido asignado al empleado"
        timeInPreviousStatusMinutes:
          type: integer
          format: int64
          description: Tiempo en el estado anterior en minutos
          example: 15

    ErrorResponse:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
          description: Timestamp del error
          example: "2025-12-02T10:30:00Z"
        status:
          type: integer
          description: Código de estado HTTP
          example: 400
        error:
          type: string
          description: Tipo de error
          example: "Bad Request"
        message:
          type: string
          description: Mensaje descriptivo del error
          example: "El campo 'orderId' es requerido"
        path:
          type: string
          description: Path de la petición que causó el error
          example: "/audit/order-status"

    # Schemas para métricas de duración de pedidos
    OrdersDurationMetricsResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            orders:
              type: array
              items:
                $ref: '#/components/schemas/OrderDurationMetric'
            summary:
              $ref: '#/components/schemas/DurationSummary'
        meta:
          $ref: '#/components/schemas/PaginationMeta'
      required:
        - data
        - meta

    OrderDurationMetric:
      type: object
      properties:
        orderId:
          type: integer
          format: int64
          description: ID del pedido
          example: 1
        clientId:
          type: integer
          format: int64
          description: ID del cliente
          example: 10
        employeeId:
          type: integer
          format: int64
          description: ID del empleado que procesó el pedido
          example: 7
        startedAt:
          type: string
          format: date-time
          description: Fecha y hora cuando el pedido inició (estado Pendiente)
          example: "2025-12-02T10:00:00Z"
        completedAt:
          type: string
          format: date-time
          description: Fecha y hora cuando el pedido finalizó (Entregado o Cancelado)
          example: "2025-12-02T10:45:00Z"
        finalStatus:
          type: string
          description: Estado final del pedido
          enum:
            - ENTREGADO
            - CANCELADO
          example: "ENTREGADO"
        durationMinutes:
          type: integer
          format: int64
          description: Duración total del pedido en minutos
          example: 45

    DurationSummary:
      type: object
      properties:
        totalOrders:
          type: integer
          description: Total de pedidos completados en el período
          example: 150
        averageDurationMinutes:
          type: number
          format: double
          description: Duración promedio de todos los pedidos en minutos
          example: 30.5
        minDurationMinutes:
          type: integer
          format: int64
          description: Duración mínima encontrada
          example: 15
        maxDurationMinutes:
          type: integer
          format: int64
          description: Duración máxima encontrada
          example: 120
        medianDurationMinutes:
          type: number
          format: double
          description: Mediana de la duración
          example: 28.0
        deliveredCount:
          type: integer
          description: Cantidad de pedidos entregados
          example: 140
        cancelledCount:
          type: integer
          description: Cantidad de pedidos cancelados
          example: 10

    # Schemas para métricas de eficiencia de empleados
    EmployeeEfficiencyMetricsResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            ranking:
              type: array
              items:
                $ref: '#/components/schemas/EmployeeEfficiencyMetric'
            summary:
              $ref: '#/components/schemas/EmployeeEfficiencySummary'
        meta:
          $ref: '#/components/schemas/PaginationMeta'
      required:
        - data
        - meta

    EmployeeEfficiencyMetric:
      type: object
      properties:
        rank:
          type: integer
          description: Posición en el ranking (1 = más eficiente)
          example: 1
        employeeId:
          type: integer
          format: int64
          description: ID del empleado
          example: 7
        totalOrdersCompleted:
          type: integer
          description: Total de pedidos completados por el empleado
          example: 45
        totalOrdersDelivered:
          type: integer
          description: Total de pedidos entregados
          example: 42
        totalOrdersCancelled:
          type: integer
          description: Total de pedidos cancelados
          example: 3
        averageDurationMinutes:
          type: number
          format: double
          description: Tiempo promedio de procesamiento en minutos
          example: 25.5
        minDurationMinutes:
          type: integer
          format: int64
          description: Tiempo mínimo de procesamiento
          example: 15
        maxDurationMinutes:
          type: integer
          format: int64
          description: Tiempo máximo de procesamiento
          example: 60
        medianDurationMinutes:
          type: number
          format: double
          description: Mediana del tiempo de procesamiento
          example: 24.0

    EmployeeEfficiencySummary:
      type: object
      properties:
        totalEmployees:
          type: integer
          description: Total de empleados en el ranking
          example: 15
        restaurantAverageDurationMinutes:
          type: number
          format: double
          description: Tiempo promedio del restaurante
          example: 30.5
        bestEmployeeAverageDurationMinutes:
          type: number
          format: double
          description: Mejor tiempo promedio entre todos los empleados
          example: 22.0
        worstEmployeeAverageDurationMinutes:
          type: number
          format: double
          description: Peor tiempo promedio entre todos los empleados
          example: 45.0
        totalOrdersProcessed:
          type: integer
          description: Total de pedidos procesados en el período
          example: 450
